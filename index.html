<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Scanner</title>
  
  <!-- Remove any local references like:
       <script src="./node_modules/html5-qrcode/html5-qrcode.min.js"></script> -->
       
  <!-- Add the html5-qrcode library from a CDN, loaded BEFORE your own script -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode"></script>
  
  <style>
    main {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      margin: 20px;
    }
    #reader {
      width: 600px;
      margin-bottom: 20px;
    }
    #result {
      text-align: center;
      margin-top: 20px;
    }
    #manualButton, #backToQr {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #manualForm {
      display: none;
      margin-top: 20px;
      text-align: left;
      width: 300px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 5px;
    }
    #manualForm label {
      display: block;
      margin: 8px 0;
    }
    #manualForm input {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <main>
    <!-- QR Reader & Result -->
    <div id="reader"></div>
    <div id="result"></div>
    <button id="manualButton">Manual Registration</button>

    <!-- Manual Registration Form -->
    <div id="manualForm">
      <h2>Manual Registration</h2>
      <form id="registrationForm">
        <label>
          Last Name: 
          <input type="text" name="lname" required />
        </label>
        <label>
          First Name: 
          <input type="text" name="fname" required />
        </label>
        <label>
          Middle Name: 
          <input type="text" name="mname" />
        </label>
        <label>
          Sex: 
          <input type="text" name="sex" required />
        </label>
        <label>
          Date of Birth: 
          <input type="text" name="dob" required />
        </label>
        <label>
          Philsys ID: 
          <input type="text" name="pcn" required />
        </label>
        <button type="submit">Submit Registration</button>
      </form>
      <button id="backToQr">Back to QR Scanning</button>
    </div>
  </main>
  
  <!-- Your custom script code goes AFTER the CDN script -->
  <script>
    let scanner; // Global variable for the scanner

    // Helper function to convert a date string into mm/dd/yyyy format
    function formatDate(dateString) {
      if (!dateString) return "";
      const date = new Date(dateString);
      if (isNaN(date)) return dateString;
      const mm = (date.getMonth() + 1).toString().padStart(2, '0');
      const dd = date.getDate().toString().padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    // Function to start the QR scanner
    function startQrScanner() {
      // Ensure the #reader element exists. If not, create it.
      if (!document.getElementById("reader")) {
        const main = document.querySelector("main");
        main.insertAdjacentHTML("afterbegin", '<div id="reader"></div>');
      }
      // Remove image file scanning option by setting showImageUrlInput to false
      scanner = new Html5QrcodeScanner('reader', { fps: 20, showImageUrlInput: false });
      scanner.render(onScanSuccess, onScanFailure);
    }

    function onScanSuccess(result) {
      console.log("Raw scanned data:", result);
      try {
        const data = JSON.parse(result);
        console.log("Parsed JSON object:", data);
        const subject = data.subject || {};

        // Extract the fields (default to an empty string if not found)
        const lname = subject.lName || "";
        const fname = subject.fName || "";
        const mName = subject.mName || "";
        const sex   = subject.sex   || "";
        const DOB   = subject.DOB   || "";
        const PCN   = subject.PCN   || "";

        // Convert the DOB into mm/dd/yyyy format
        const formattedDOB = formatDate(DOB);

        // Fill in the manual registration form fields with the scanned data
        document.querySelector('input[name="lname"]').value = lname;
        document.querySelector('input[name="fname"]').value = fname;
        document.querySelector('input[name="mname"]').value = mName;
        document.querySelector('input[name="sex"]').value   = sex;
        document.querySelector('input[name="dob"]').value   = formattedDOB;
        document.querySelector('input[name="pcn"]').value   = PCN;

        document.getElementById('result').innerHTML = `
          <h2>QR Data Captured</h2>
          <p>The manual registration form has been filled with scanned data (DOB formatted as mm/dd/yyyy). Please verify or edit the data and submit.</p>
        `;
        // Show the manual form for verification/editing
        document.getElementById("manualForm").style.display = "block";

      } catch (e) {
        console.error("Error parsing JSON:", e);
        document.getElementById('result').innerHTML = `
          <h2>Error</h2>
          <p>Could not parse QR code data as JSON.</p>
          <p>${e}</p>
        `;
      }

      // Stop scanning and remove the scanner element
      scanner.clear();
      document.getElementById('reader').remove();
    }

    function onScanFailure(err) {
      console.error("QR code parse error, error =", err);
    }

    // When "Manual Registration" is clicked:
    document.getElementById("manualButton").addEventListener("click", function() {
      if (scanner) {
        scanner.clear();
      }
      if (document.getElementById("reader")) {
        document.getElementById("reader").remove();
      }
      document.getElementById("manualForm").style.display = "block";
      document.getElementById("result").innerHTML = "";
    });

    // When "Back to QR Scanning" is clicked:
    document.getElementById("backToQr").addEventListener("click", function() {
      document.getElementById("manualForm").style.display = "none";
      document.getElementById("result").innerHTML = "";
      startQrScanner();
    });

    // Handle the manual registration form submission and update the Google Spreadsheet
    document.getElementById("registrationForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const lname = formData.get("lname");
      const fname = formData.get("fname");
      const mname = formData.get("mname");
      const sex   = formData.get("sex");
      const dob   = formData.get("dob");
      const pcn   = formData.get("pcn");

      // Use the new Google Apps Script web app URL
      const scriptURL = "https://script.google.com/macros/s/AKfycbwWbVonTUt82Y212Rp_ebyFV-QnlpIYnUiKxyWJMGOpPq3E8O9IP2udXgrh7Qkj-BdQ/exec";
      const params = `?lname=${encodeURIComponent(lname)}&fname=${encodeURIComponent(fname)}&mname=${encodeURIComponent(mname)}&sex=${encodeURIComponent(sex)}&dob=${encodeURIComponent(dob)}&pcn=${encodeURIComponent(pcn)}`;
      const fullURL = scriptURL + params;
      console.log("Submitting to URL:", fullURL);

      fetch(fullURL)
        .then(response => response.text())
        .then(resultText => {
          document.getElementById("result").innerHTML = `
            <h2>Registration Submitted</h2>
            <p>${resultText}</p>
          `;
          // Optionally hide the form after submission
          document.getElementById("manualForm").style.display = "none";
        })
        .catch(error => {
          console.error("Error updating Google Spreadsheet:", error);
          document.getElementById("result").innerHTML = `
            <h2>Error</h2>
            <p>There was an error submitting your registration. Please try again.</p>
          `;
        });
    });

    // Start the QR scanner on initial load
    startQrScanner();
  </script>
</body>
</html>
